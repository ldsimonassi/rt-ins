<h1>Bienvenido <%= "#{@user.first_name} #{@user.last_name}" %></h1>

<!--
<section id="menulateral" class="col-md-3 col-md-offset-0">
	<ul id="menu">
	<% @vehicles.each do |v| %>

		<li class="ui-widget-header"><%= "#{v.price.version.model.name} #{v.price.version.name}"%></li>
		
		<li>Control de la unidad</li>
	    <li>Servicios contratados</li>
	    <li>Optimizaciones</li>
	    <li>Alertas</li>
	<% end %>
	</ul>
</section>

-->

<div id="mapid" class="col-md-12 col-md-offset-0" style="height: 800px"></div>
    <script>
    //width: 600px;
    //

        var mymap = L.map('mapid').setView([-34.573,-58.4801], 13);
        var colors = ['#0000FF', '#8A2BE2', '#DC143C', '#00008B', '#006400', '#FFD700', 
        			  '#FF69B4', '#4B0082', '#00FF00', '#00FA9A', '#B0E0E6', '#FF0000', 
        			  '#FF00FF'];

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);




        // Periodic API Call
        // vehicles{} = parseVehicles(JSON)
        // update()

        user_id = <%= raw current_user.id %>;
        vehicles = <%= raw get_user_vehicles_and_locations(current_user, '20160615').to_json %>;
        //polys = [:];

        function draw_vehicles() {
	        for (var i = vehicles.length - 1; i >= 0; i--) {
	        	locations = vehicles[i].locations
	        	if(locations.length > 0) {
					vehicles[i]['poly'] = L.polyline(locations, {color:'red', noClip:'false'});
					vehicles[i]['poly'].addTo(mymap);
					L.rectangle(vehicles[i]['poly'].getBounds(), {color: 'orange', fillOpacity: 0.1}).addTo(mymap);
					mymap.fitBounds(vehicles[i]['poly'].getBounds());
				}
	        }
	    }



	    function request_locations() {
			if(!requesting) {
				requesting = true;
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (xhttp.readyState == 4 && xhttp.status == 200) {
						//JSON: xhttp.responseText
						parsed = JSON.parse(xhttp.responseText)
						console.log(parsed);
						requesting = false;
					}
				};
				xhttp.open("GET", "/users/"+user_id+"/locations", true);
				xhttp.send();
			}
		}

		requesting = false;
		//request update every 5 seconds
		setInterval(request_locations, 5000);

        // L.marker([51.5, -0.09]).addTo(mymap)
        //     .bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

        // L.circle([51.508, -0.11], 500, {
        //     color: 'red',
        //     fillColor: '#f03',
        //     fillOpacity: 0.5
        // }).addTo(mymap).bindPopup("I am a circle.");

        // L.polygon([
        //     [51.509, -0.08],
        //     [51.503, -0.06],
        //     [51.51, -0.047]
        // ]).addTo(mymap).bindPopup("I am a polygon.");


        // var popup = L.popup();

        // function onMapClick(e) {
        //     popup
        //         .setLatLng(e.latlng)
        //         .setContent("You clicked the map at " + e.latlng.toString())
        //         .openOn(mymap);
        // }

        // mymap.on('click', onMapClick);

    </script>

<p></p>
<div class="col-md-6 col-md-offset-0"><%= link_to "Registrar vehÃ­culo", new_vehicle_path %></div>    
